---
name: Publish Python 🐍 distributions 📦 to PyPI
on:
  push:
    tags:
      - "v*"
jobs:
  check-status:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'gepa-ai'
    outputs:
      status_checks_passed: ${{ steps.check_status.outputs.passed }}
    steps:
      # This workflow should only execute if all workflows from run_tests.yml passed successfully on the current commit
      - name: Check if all required status checks passed
        id: check_status
        run: |
          # Get the current commit SHA
          COMMIT_SHA="${{ github.sha }}"
          
          # Check if all required status checks have passed
          # We need to check the following jobs from run_tests.yml:
          # - fix
          # - test (for all Python versions: 3.10, 3.11, 3.12, 3.13)
          # - build_package (for all Python versions: 3.10, 3.11, 3.12, 3.13)
          
          # Wait a bit for all status checks to complete
          sleep 10
          
          # Check the status of the workflow run
          WORKFLOW_STATUS=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/status --jq '.statuses[] | select(.context | contains("fix") or contains("test") or contains("build_package")) | .state' 2>/dev/null || echo "")
          
          if [ -z "$WORKFLOW_STATUS" ]; then
            echo "❌ Could not retrieve status checks for commit $COMMIT_SHA"
            echo "passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          # Check if any status is not 'success'
          FAILED_CHECKS=$(echo "$WORKFLOW_STATUS" | grep -v "success" || true)
          
          if [ -n "$FAILED_CHECKS" ]; then
            echo "❌ Some required status checks failed:"
            echo "$FAILED_CHECKS"
            echo "passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          echo "✅ All required status checks passed successfully"
          echo "passed=true" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  extract-tag:
    runs-on: ubuntu-latest
    needs: check-status
    if: github.repository_owner == 'gepa-ai' && needs.check-status.outputs.status_checks_passed == 'true'
    outputs:
      version: ${{ steps.extract_tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - id: extract_tag
        name: Extract tag name
        run: |
          # Extract tag and remove 'v' prefix to get semver
          TAG=$(echo $GITHUB_REF | cut -d / -f 3)
          VERSION=${TAG#v}
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"

  build-and-publish-test-pypi:
    needs: [check-status, extract-tag]
    if: github.repository_owner == 'gepa-ai' && needs.check-status.outputs.status_checks_passed == 'true'
    runs-on: ubuntu-latest
    environment:
      name: pypi
    permissions:
      id-token: write # IMPORTANT: mandatory for trusted publishing
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Set up latest uv
        uses: astral-sh/setup-uv@v6
        with:
          version: latest
      - name: Install build dependencies
        run: uv pip install ".[build]"
      - name: Get correct version for TestPyPI release
        id: check_version
        run: |
          VERSION=${{ needs.extract-tag.outputs.version }}  
          PACKAGE_NAME="gepa"
          echo "Checking if $VERSION for $PACKAGE_NAME exists on TestPyPI"  
          NEW_VERSION=$(python3 .github/workflows/build_utils/test_version.py $PACKAGE_NAME $VERSION)  
          echo "Version to be used for TestPyPI release: $NEW_VERSION"  
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
      - name: Update version in pyproject.toml
        run: sed -i '/#replace_package_version_marker/{n;s/version="[^"]*"/version="${{ needs.extract-tag.outputs.version }}"/;}' pyproject.toml
      - name: Build a binary wheel
        run: uv run python -m build
      # Test the locally built wheel
      - name: Create test environment
        run: uv venv test_before_testpypi
      - name: Test package installation and functionality
        run: |
          source test_before_testpypi/bin/activate
          # Install the locally built wheel and testing dependencies
          WHEEL_FILE=$(ls dist/*.whl | head -1)
          uv pip install "$WHEEL_FILE[dev]" pytest
          pytest tests/
          deactivate
      # Publish to test-PyPI
      - name: Publish distribution 📦 to test-PyPI
        uses: pypa/gh-action-pypi-publish@release/v1 # This requires a trusted publisher to be setup in pypi/testpypi
        with:
          repository-url: https://test.pypi.org/legacy/

  # TODO: Add tests using gepa

  build-and-publish-pypi:
    needs: [check-status, extract-tag, build-and-publish-test-pypi]
    # Only publish to PyPI if the repository owner is gepa-ai and status checks pass
    if: github.repository_owner == 'gepa-ai' && needs.check-status.outputs.status_checks_passed == 'true'
    runs-on: ubuntu-latest
    environment:
      name: pypi
    permissions:
      id-token: write # IMPORTANT: mandatory for trusted publishing
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Set up latest uv
        uses: astral-sh/setup-uv@v6
        with:
          version: latest
      - name: Install build dependencies
        run: uv pip install ".[build]"
      - name: Get correct version for PyPI release
        id: check_version
        run: |
          VERSION=${{ needs.extract-tag.outputs.version }}  
          PACKAGE_NAME="gepa"
          echo "Checking if $VERSION for $PACKAGE_NAME exists on PyPI"  
          NEW_VERSION=$(python3 .github/workflows/build_utils/test_version.py $PACKAGE_NAME $VERSION)  
          echo "Version to be used for PyPI release: $NEW_VERSION"  
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
      - name: Update version in pyproject.toml
        run: sed -i '/#replace_package_version_marker/{n;s/version="[^"]*"/version="${{ steps.check_version.outputs.version }}"/;}' pyproject.toml
      - name: Build a binary wheel
        run: uv run python -m build
      # Test the locally built wheel before publishing to pypi
      - name: Create test environment
        run: uv venv test_before_pypi
      - name: Test package installation and functionality
        run: |
          source test_before_pypi/bin/activate
          # Install the locally built wheel and testing dependencies
          WHEEL_FILE=$(ls dist/*.whl | head -1)
          uv pip install "$WHEEL_FILE[dev]" pytest
          pytest tests/
          deactivate
          rm -r test_before_pypi
      - name: Publish distribution 📦 to PyPI (gepa)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          attestations: false
      - uses: stefanzweifel/git-auto-commit-action@v5 # auto commit changes to main
        with:
          commit_message: Update versions
          create_branch: true
          branch: release-${{ needs.extract-tag.outputs.version }}
      - name: Checkout main branch
        run: |
          git fetch origin
          git checkout main
      - name: Configure git user
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Github Actions"
      - name: Merge release branch into main
        run: |
          git merge --no-ff release-${{ needs.extract-tag.outputs.version }}
      - name: Push changes to main
        run: |
          git push origin main